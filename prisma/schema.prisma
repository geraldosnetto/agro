generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id                     String             @id @default(cuid())
  name                   String?
  email                  String             @unique
  emailVerified          DateTime?
  image                  String?
  password               String?
  plan                   String             @default("free")
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  role                   Role               @default(USER)
  stripeCurrentPeriodEnd DateTime?
  stripeCustomerId       String?            @unique
  stripePriceId          String?
  stripeSubscriptionId   String?            @unique
  aiUsage                AIUsage[]
  accounts               Account[]
  alertas                AlertaUsuario[]
  chatConversations      ChatConversation[]
  favoritos              Favorito[]
  sessions               Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model AlertaUsuario {
  id          String   @id @default(cuid())
  userId      String
  commodityId String
  tipo        String
  valorAlvo   Decimal? @db.Decimal(10, 2)
  percentual  Decimal? @db.Decimal(5, 2)
  ativo       Boolean  @default(true)
  disparado   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([commodityId])
}

model Favorito {
  id          String   @id @default(cuid())
  userId      String
  commodityId String
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, commodityId])
  @@index([userId])
}

model Commodity {
  id        String    @id @default(cuid())
  slug      String    @unique
  nome      String
  categoria Categoria
  unidade   Unidade
  descricao String?
  icone     String?
  ativo     Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  alertas   Alerta[]
  cotacoes  Cotacao[]

  @@index([categoria])
  @@index([slug])
}

model Cotacao {
  id             String    @id @default(cuid())
  commodityId    String
  valor          Decimal   @db.Decimal(10, 2)
  valorAnterior  Decimal?  @db.Decimal(10, 2)
  variacao       Decimal?  @db.Decimal(10, 2)
  praca          String
  estado         String
  fonte          String
  fonteUrl       String?
  dataReferencia DateTime
  createdAt      DateTime  @default(now())
  commodity      Commodity @relation(fields: [commodityId], references: [id], onDelete: Cascade)

  @@unique([commodityId, praca, dataReferencia])
  @@index([commodityId])
  @@index([dataReferencia])
  @@index([commodityId, dataReferencia])
  @@index([estado])
}

model Alerta {
  id          String    @id @default(cuid())
  commodityId String
  email       String
  tipo        String
  valorAlvo   Decimal   @db.Decimal(10, 2)
  ativo       Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  commodity   Commodity @relation(fields: [commodityId], references: [id], onDelete: Cascade)

  @@index([commodityId])
  @@index([email])
}

model AtualizacaoLog {
  id        String   @id @default(cuid())
  fonte     String
  status    String
  mensagem  String?
  registros Int      @default(0)
  duracao   Int?
  createdAt DateTime @default(now())

  @@index([fonte])
  @@index([createdAt])
}

model CotacaoDolar {
  id             String   @id @default(cuid())
  dataReferencia DateTime @unique
  compra         Decimal  @db.Decimal(10, 4)
  venda          Decimal  @db.Decimal(10, 4)
  createdAt      DateTime @default(now())

  @@index([dataReferencia])
}

model NewsAccess {
  url       String   @id
  title     String
  source    String
  clicks    Int      @default(1)
  updatedAt DateTime @updatedAt

  @@index([clicks(sort: Desc)])
}

model AIReport {
  id          String   @id @default(cuid())
  type        String
  commodityId String?
  title       String
  content     String
  summary     String?
  model       String
  tokensUsed  Int
  generatedAt DateTime @default(now())
  validUntil  DateTime
  dataHash    String?
  reportDate  DateTime @default(now()) @db.Date

  @@unique([type, reportDate, commodityId])
  @@index([type, generatedAt])
  @@index([type, reportDate])
  @@index([commodityId])
}

model ChatConversation {
  id        String        @id @default(cuid())
  userId    String
  title     String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  ChatMessage[]

  @@index([userId, updatedAt])
}

model ChatMessage {
  id             String           @id @default(cuid())
  conversationId String
  role           String
  content        String
  tokensUsed     Int?
  model          String?
  createdAt      DateTime         @default(now())
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

model PricePrediction {
  id              String   @id @default(cuid())
  commodityId     String
  predictedValue  Decimal  @db.Decimal(10, 2)
  confidenceLevel Decimal  @db.Decimal(5, 2)
  direction       String
  horizon         Int
  model           String
  dataPointsUsed  Int
  generatedAt     DateTime @default(now())
  targetDate      DateTime
  actualValue     Decimal? @db.Decimal(10, 2)
  wasAccurate     Boolean?

  @@index([commodityId, generatedAt])
  @@index([targetDate])
}

model NewsSentiment {
  id               String   @id @default(cuid())
  newsUrl          String   @unique
  newsTitle        String
  sentiment        String
  score            Decimal  @db.Decimal(3, 2)
  commodities      String[]
  impactScore      Decimal  @db.Decimal(3, 2)
  analyzedAt       DateTime @default(now())
  drivers          String[]
  emotion          String?
  emotionIntensity Decimal? @db.Decimal(3, 2)
  reasoning        String?
  timeframe        String?
  model            String?
  tokensUsed       Int?     @default(0)

  @@index([sentiment])
  @@index([analyzedAt])
  @@index([emotion])
}

model PriceAnomaly {
  id               String   @id @default(cuid())
  commodityId      String
  type             String
  severity         String
  description      String
  detectedValue    Decimal  @db.Decimal(10, 2)
  expectedRange    String
  deviationPercent Decimal  @db.Decimal(5, 2)
  detectedAt       DateTime @default(now())
  acknowledged     Boolean  @default(false)

  @@index([commodityId, detectedAt])
  @@index([severity])
}

model AIUsage {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @db.Date
  chatMessages    Int      @default(0)
  reportsViewed   Int      @default(0)
  predictionsUsed Int      @default(0)
  tokensUsed      Int      @default(0)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

model PodcastEpisode {
  id          String   @id @default(cuid())
  title       String
  description String
  audioUrl    String
  duration    Int?
  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([publishedAt(sort: Desc)])
}

enum Role {
  USER
  ADMIN
}

enum Categoria {
  GRAOS
  PECUARIA
  SUCROENERGETICO
  FIBRAS
  OUTROS
  PEIXE
}

enum Unidade {
  SACA_60KG
  ARROBA
  LITRO
  TONELADA
  KG
  CABECA
  DUZIA
}
