generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// ==================== AUTH ====================

// Usuário
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // Para login com email/senha

  // Plano do usuário
  plan          String    @default("free") // free, pro, business

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  alertas       AlertaUsuario[]
  favoritos     Favorito[]
}

// Conta OAuth (Google, GitHub, etc)
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// Sessão de usuário
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Token de verificação de email
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Alerta de preço do usuário (relacionado com User)
model AlertaUsuario {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  commodityId String

  tipo        String    // "ACIMA" | "ABAIXO" | "VARIACAO"
  valorAlvo   Decimal?  @db.Decimal(10, 2)
  percentual  Decimal?  @db.Decimal(5, 2) // Para alerta de variação
  ativo       Boolean   @default(true)
  disparado   Boolean   @default(false)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([commodityId])
}

// Commodities favoritas do usuário
model Favorito {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  commodityId String

  createdAt   DateTime @default(now())

  @@unique([userId, commodityId])
  @@index([userId])
}

// ==================== COMMODITIES ====================

// Categoria de commodity
enum Categoria {
  GRAOS
  PECUARIA
  SUCROENERGETICO
  FIBRAS
  OUTROS
}

// Unidade de medida
enum Unidade {
  SACA_60KG      // sc 60kg (soja, milho)
  ARROBA         // @ (boi gordo)
  LITRO          // litro (etanol)
  TONELADA       // ton (açúcar)
  KG             // kg (café)
}

// Commodity (produto agrícola)
model Commodity {
  id          String    @id @default(cuid())
  slug        String    @unique // ex: "soja", "boi-gordo"
  nome        String    // ex: "Soja"
  categoria   Categoria
  unidade     Unidade
  descricao   String?
  icone       String?   // emoji ou path do ícone
  ativo       Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  cotacoes    Cotacao[]
  alertas     Alerta[]

  @@index([categoria])
  @@index([slug])
}

// Cotação de preço
model Cotacao {
  id            String    @id @default(cuid())
  commodityId   String
  commodity     Commodity @relation(fields: [commodityId], references: [id], onDelete: Cascade)
  
  valor         Decimal   @db.Decimal(10, 2)
  valorAnterior Decimal?  @db.Decimal(10, 2)
  variacao      Decimal?  @db.Decimal(10, 2)
  
  praca         String    // ex: "Paranaguá/PR", "São Paulo/SP"
  estado        String    // ex: "PR", "SP"
  
  fonte         String    // ex: "CEPEA", "CONAB"
  fonteUrl      String?
  
  dataReferencia DateTime // data da cotação
  createdAt      DateTime @default(now())

  @@unique([commodityId, praca, dataReferencia])
  @@index([commodityId])
  @@index([dataReferencia])
  @@index([commodityId, dataReferencia]) // Otimização para o Ticker (última cotação por commodity)
  @@index([estado])
}

// Alerta de preço (futuro)
model Alerta {
  id          String    @id @default(cuid())
  commodityId String
  commodity   Commodity @relation(fields: [commodityId], references: [id], onDelete: Cascade)
  
  email       String
  tipo        String    // "ACIMA" | "ABAIXO"
  valorAlvo   Decimal   @db.Decimal(10, 2)
  ativo       Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([commodityId])
  @@index([email])
}

// Log de atualização de dados
model AtualizacaoLog {
  id        String   @id @default(cuid())
  fonte     String   // "BCB", "CEPEA", "CONAB"
  status    String   // "SUCCESS", "ERROR"
  mensagem  String?
  registros Int      @default(0)
  duracao   Int?     // ms
  createdAt DateTime @default(now())

  @@index([fonte])
  @@index([createdAt])
}

// Cotação do dólar (PTAX)
model CotacaoDolar {
  id             String   @id @default(cuid())
  dataReferencia DateTime @unique
  compra         Decimal  @db.Decimal(10, 4)
  venda          Decimal  @db.Decimal(10, 4)
  createdAt      DateTime @default(now())

  @@index([dataReferencia])
}
